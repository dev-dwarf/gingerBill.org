<!DOCTYPE html>
<html class="no-js" lang="en-GB" prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
<head>

	<meta charset="utf-8">


	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="description" content="">
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<meta name="description" content="A Defer Statement for C&#43;&#43;11">
	<meta name="keywords" content="c&#43;&#43;, c&#43;&#43;11, golang, ">

	 
	<meta property="og:type" content="article">
	<meta property="og:description" content="A Defer Statement for C&#43;&#43;11">
	<meta property="og:title" content="A Defer Statement for C&#43;&#43;11">
	<meta property="og:site_name" content="gingerBill">
	<meta property="og:image" content="">
	<meta property="og:image:type" content="image/jpeg">
	<meta property="og:image:width" content="">
	<meta property="og:image:height" content="">
	<meta property="og:url" content="http://localhost:1313/post/defer-c&#43;&#43;11/">
	<meta property="og:locale" content="en_GB">

	<meta property="article:published_time" content="2015-08-19">
	<meta property="article:modified_time" content="2015-08-19">


	
	<meta property="article:tag" content="c&#43;&#43;"><meta property="article:tag" content="c&#43;&#43;11"><meta property="article:tag" content="golang">
	


	
	<meta name="twitter:card" content="summary">
	
	<meta name="twitter:site" content="@TheGingerBill">
	<meta name="twitter:title" content="A Defer Statement for C&#43;&#43;11">
	<meta name="twitter:creator" content="@TheGingerBil">
	<meta name="twitter:description" content="A Defer Statement for C&#43;&#43;11">
	<meta name="twitter:image:src" content="">
	<meta name="twitter:domain" content="gingerBill.org">


	<base href="http://localhost:1313/">
	<title>A Defer Statement for C&#43;&#43;11 &middot; gingerBill</title>
	<link rel="canonical" href="http://localhost:1313/post/defer-c&#43;&#43;11/">
	

	
	<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Open+Sans:300,400italic,400,600">

	
	<script type="text/javascript" src="http://localhost:1313/js/prism.js"></script>
	<link rel="stylesheet" href="http://localhost:1313/css/prism.css">

	
	<link rel="stylesheet" href="http://localhost:1313/css/normalize.css">
	<link rel="stylesheet" href="http://localhost:1313/css/style.css">

</head>

<body lang="en" itemscope itemtype="http://schema.org/Article">
<header id="header">
<div>
	<h1><a href="http://localhost:1313/" border="0" id="logo-link"><span class="ginger">ginger</span>Bill<sup class="tm">&trade;</sup></a></h1>
	<div id="three-lines" onclick="navToggle();">&#x2630;</div>
	<nav id="main-nav">
		<ul>
			<li><a href="http://localhost:1313/">Home</a></li>
			<li><a href="http://localhost:1313/post/">Blog</a></li>
			<li><a href="http://localhost:1313/projects/">Projects</a></li>
			<li><a href="http://localhost:1313/about/">About</a></li>
		</ul>
	</nav>
</div>
</header>

<section id="main">
	<article itemprop="articleBody" class="container">
		<header>
			<h1 itemprop="name" class="title">A Defer Statement for C&#43;&#43;11</h1>
	
	

	

						<div class="section-nav">
				<section class="prev">
					←&nbsp;<a href="http://localhost:1313/post/welcome/">Welcome</a>
				</section>
				<section class="next">
					
				</section>
			</div>



			<p class="date">19 Aug 2015</p>
		</header>
			

<p>One of my favourite things about <a href="https://golang.org/">Go</a> is the <code>defer</code> statement. The <code>defer</code> statement pushes a function call onto a list; the list of saved calls in called when the function returns.</p>

<p>Imitating this is C++ is impossible. Instead of calling when the function calls, you can call at the end of scope; this is a better approach for C++. This is similar to how <a href="http://dlang.org/statement.html#ScopeGuardStatement">D has scope(exit)</a>.</p>

<h2 id="c-11-implementation:ae09ca82e990da28e31971a214fcfd4e">C++11 Implementation</h2>

<pre><code class="language-cpp">// This code requires C++11 features such as move semantics
#include &lt;functional&gt;

namespace Impl
{
template &lt;typename Func&gt;
struct Defer
{
    Func func;
    Defer(Func&amp;&amp; func)
    : func(std::forward&lt;Func&gt;(func))
    {
    }

    ~Defer()
    {
        func();
    }
};

template &lt;typename Func&gt;
Defer&lt;Func&gt; deferFunc(Func&amp;&amp; func)
{
    return Defer&lt;Func&gt;(std::forward&lt;Func&gt;(func));
}

#define DEFER_1(x, y) x##y
#define DEFER_2(x, y) DEFER_1(x, y)
#define DEFER_3(x) DEFER_2(x, __COUNTER__)
#define defer(code) auto DEFER_3(_defer_) = Impl::deferFunc([&amp;](){code;});

} // namespace Impl

</code></pre>

<h2 id="explanation:ae09ca82e990da28e31971a214fcfd4e">Explanation</h2>

<p>One of the most common examples for this in Go is files.</p>

<pre><code class="language-go">import &quot;os&quot;

func someFunc() {
    file, err := os.Open(&quot;filename.ext&quot;, os.O_RDONLY, 0)
    if err != nil {
        // handle error
        return
    }
    defer os.Close(file)
    // Do whatever

    return // No need to close file explicitly
}
</code></pre>

<p>In C/C++, before every return, <code>fclose</code> must be called.</p>

<pre><code class="language-cpp">void someFunc()
{
    FILE* file = fopen(&quot;filename.ext&quot;, &quot;rb&quot;);
    if (file == nullptr)
    {
        // handle error
        return;
    }

    if (someTest)
    {
        // ...

        fclose(file); // Have to explicitly close file
        return;
    }


    fclose(file); // Have to explicit close file
}
}
</code></pre>

<p>You may say that RAII in C++ solves this issue but this would require a class wrapper. <code>defer</code> allows for the same thing as RAII but without manually creating a wrapper type.</p>

<p>Also, <code>defer</code> conceptually links the creation with the destruction without hiding it.</p>

<h2 id="examples-in-c-code:ae09ca82e990da28e31971a214fcfd4e">Examples in C++ Code</h2>

<pre><code class="language-cpp">
void someFunc()
{
    FILE* file = fopen(&quot;filename.ext&quot;, &quot;rb&quot;);
    if (file == nullptr)
        return;
    defer(fclose(file));

    u8* buffer = (u8*)allocate(64 * sizeof(u8));
    if (buffer == nullptr)
        return; // fclose is called automatically
    defer(deallocate(buffer));

    defer({
        printf(&quot;You can even defer &quot;);
        printf(&quot;an entire block too!&quot;);
    });

    // Do whatever...
}
</code></pre>

<p>I use this regularly within code (especially in the <a href="https://github.com/gingerBill/Dunjun">Dunjun</a> series). It is very useful when dealing with C code bases.</p>

<p>There are numerous other implementations of this too and I have linked to these below.</p>

<h3 id="other-implementations:ae09ca82e990da28e31971a214fcfd4e">Other Implementations</h3>

<ul>
<li><a href="http://the-witness.net/news/2012/11/scopeexit-in-c11/">Ignacio Castaño</a></li>
<li><a href="http://blog.korfuri.fr/post/go-defer-in-cpp/">Korfuri</a></li>
<li><a href="http://kri.gs/2013/01/20/defer-cpp/">Kristoffer Grönlund</a></li>
</ul>

<h2 id="caveat:ae09ca82e990da28e31971a214fcfd4e">Caveat</h2>

<p>Because the <code>defer</code> statement is called at the end of scope rather than function return, a Go programmer would example something like this:</p>

<pre><code class="language-cpp">void anotherFunc()
{
    for (int i = 0; i &lt; 4; i++)
        defer(printf(&quot;%d &quot;, i));
    printf(&quot;Hello &quot;);
}
</code></pre>

<p>to return <code>Hello 0 1 2 3</code>. However, it will return <code>0 1 2 3 Hello</code>. I personally prefer the scope behaviour but that is just a matter of opinion.</p>


						<div class="section-nav">
				<section class="prev">
					←&nbsp;<a href="http://localhost:1313/post/welcome/">Welcome</a>
				</section>
				<section class="next">
					
				</section>
			</div>


	</article>
</section>
<aside id="meta">
	<div id="author">
		<p>Author: Ginger Bill</p>
	</div>

	<div id="categories">
		<h4>Categories:</h4>
		<ul>
		
			<li><a href="http://localhost:1313/topics/programming/">Programming</a></li>
		
		</ul>
	</div>


	<div id="tags">
		<h4>Tags:</h4>
		<ul>
		
			<li><a href="http://localhost:1313/tags/c/">c&#43;&#43;</a></li>
		
			<li><a href="http://localhost:1313/tags/c11/">c&#43;&#43;11</a></li>
		
			<li><a href="http://localhost:1313/tags/golang/">golang</a></li>
		
		</ul>
	</div>




<meta itemprop="wordCount" content="444">
<meta itemprop="datePublished" content="2015-08-19">
<meta itemprop="url" content="http://localhost:1313/post/defer-c&#43;&#43;11/">

</aside>

<section id="comments" name="comments">
	<h1>Comments</h1>
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		(function() {
			if (window.location.hostname == "localhost")
				return;

			var dsq = document.createElement('script');
			dsq.type = 'text/javascript';
			dsq.async = true;
			var disqus_shortname = 'gingerbill';
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


<footer>
	<div>
		<p>
			&copy; 2007 &ndash; 2015 <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Ginger Bill</span></span>
		</p>
	</div>
</footer>
<script type="text/javascript" async defer>
	function navToggle() {
		var mainNav = document.getElementById('main-nav');
		var threeLines = document.getElementById('three-lines');

		if (mainNav.getAttribute('class')) {
			mainNav.className = "";
			threeLines.innerHTML = "&#x2630;";
		} else {
			mainNav.className = "open";
			threeLines.innerHTML = "&#x2715;";
		}
	}
</script>

<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':1313/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

